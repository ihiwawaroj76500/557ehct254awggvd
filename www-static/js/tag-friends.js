var commentParent=[],friendList=[];function prepareTagging(){$j(".js_tagTextarea").parent("div").addClass("js_taggableContainer"),$j(".js_taggableContainer").each(function(){$j(this).find(".js_taggable").length<1&&($j(this).find(".js_tagTextarea").before('<div data-placeholder="Share what you think" contenteditable="true" tabindex="0" maxlength="500" class="js_taggable taggablePlaceholder"></div>'),$j(".js_tagTextarea").hide(),$j(this).find(".js_taggable").addClass("ui-autocomplete-input"))})}function syncCharacterCount(t){var e=500-t.find(".js_taggable").text().length-1;t.closest("form").find("input.countdownCharacters").html(e),t.closest("form").find("input.countdownCharacters").val(e)}function autocompleteDone(t,e,a){commentParent.find(".js_taggable").autocomplete("destroy");var n=t;-1==friendList.indexOf(n)&&friendList.push(n);var r=$j(".tagTrigger").text(),o=commentParent.find(".js_taggable").text(),g=commentParent.find(".js_taggable").caret();o.substring(o.length-r.length,o.length),g-=r.length;var o=o.substring(0,g)+o.substring(g+r.length,o.length),i=g+(s=String("@"+t)).length+1,m=$j("html.firefox"),s=" "+s+(0<a.length||0<m.length?"&nbsp;":" "),c=[o.slice(0,g),s,o.slice(g)].join("");commentParent.find(".js_taggable").html(c),$j(".currentTag").removeClass("currentTag"),startOfTag=null,$j(".tagTrigger").remove(),commentParent.removeAttr("tagenabled"),commentParent.find(".js_taggable").focus(),i++,commentParent.find(".js_taggable").caret(i)}function pushCommentData(t){var e=$j(t),a=e.closest("form").find(".js_tagTextarea");commentTyper=e.closest("form").find(".js_taggable").text();var n=commentTyper.split(/[\s,]+/);$j.map(friendList,function(t){var e;-1!=n.indexOf("@"+t)&&(e=new RegExp("@"+t,"g"),commentTyper=commentTyper.replace(e,"#*@"+t+"*#"))});var r=new RegExp("<(\"[^\"]*?\"|'[^']*?'|[^'\">])*>","gi");return commentTyper.match(r)&&(commentTyper=commentTyper.sanitize()),a.html(""),a.val(""),a.text(""),a.html(commentTyper),a.val(commentTyper),a.text(commentTyper),commentTyper}head.ready(document,function(){var a=$j(".js_taggable").closest(".js_taggableContainer").find(".js_taggable > *:last-child"),r=$j(".chrome, .safari"),m=0;function s(t){var e=String(t.find(".js_taggable").html());a.is(".tagTrigger")||t.find(".js_tagTextarea").val(e)}function c(){var n=commentParent.find("span.tagTrigger").text(),t=0<r.length?2:1,e=-1==m?1:t,n=n.substring(e,n.length);$j(".currentTag").autocomplete({minLength:1,appendTo:commentParent,focus:function(){return!1},source:function(t,e){var a;commentParent.attr("tagenabled")&&(n=n||"",a=String("/chat/friends_json?search="+n),$j.ajax({url:a,dataType:"json",success:function(t){e($j.map(t,function(t){return{username:t.username,avatar:t.avatar,userId:t.id}}))}}))},select:function(t,e){autocompleteDone(e.item.username,e.item.userId,r),commentParent.removeAttr("tagenabled"),n=null}}),commentParent.attr("tagenabled")&&commentParent.find(".currentTag").data()&&(commentParent.find(".currentTag").data("ui-autocomplete")._renderItem=function(t,e){if(commentParent.attr("tagenabled"))return $j('<li class="listedFriend"></li>').append('<a><img class="listedFriendAvatar" src='+e.avatar+' /><span class="listedFriendUsername">'+e.username+"</span></a>").data("ui-autocomplete-item",e).appendTo(t)})}0<r.length?$j(document).on("keydown",".js_taggable",function(t){$j(this).addClass("currentTag"),commentParent=$j(this).parent("div.js_taggableContainer");var e,a="37"==t.which?"":decodeURI(String.fromCharCode(t.which)),n=t.keyCode||t.charCode,r=String($j(this).html()).slice(-1),o=$j(this).caret()+1,g=$j(this).text(),i=m?g.substring(m,o)+a:"";37!=n&&39!=n||!$j(".taggablePlaceholder ").hasClass("activeEdit")||t.stopPropagation(),!t.shiftKey||50!=n||""!==r&&";"!==r?8==t.which?"@"==r?(commentParent.find(".tagTrigger").remove(),commentParent.removeAttr("tagenabled"),m=null,$j(".currentTag").removeClass("currentTag"),commentParent.find(".js_taggable").autocomplete("destroy")):(e=(e=i).substring(0,e.length-2),commentParent.find(".tagTrigger").html(e)):46==n||(32==n&&commentParent.attr("tagenabled")?(commentParent.removeAttr("tagenabled"),commentParent.find(".js_taggable").autocomplete("destroy"),commentParent.find(".tagTrigger").remove()):38==t.which||40==t.which||189==n&&commentParent.attr("tagenabled")||commentParent.attr("tagenabled")&&commentParent.find(".tagTrigger").html(i)):(commentParent.attr("tagenabled","true"),m=$j(this).caret()-1,commentParent.find(".tagTrigger").remove(),commentParent.append('<span class="tagTrigger">@</span>')),s(commentParent),commentParent.attr("tagenabled")&&c(),syncCharacterCount(commentParent)}):$j(document).on("keypress",".js_taggable",function(t){$j(this).addClass("currentTag"),commentParent=$j(this).parent("div.js_taggableContainer");var e,a=String.fromCharCode(t.which),n=t.keyCode||t.charCode,r=String($j(this).text()).slice(-1),o=$j(this).caret()+1,g=$j(this).text(),i=m?g.substring(m,o)+a:"";37!=n&&39!=n||!$j(".taggablePlaceholder ").hasClass("activeEdit")||t.stopPropagation(),"@"!==a||""!=r&&" "!=r&&";"!=r&&"\n"!=r?8==n?"@"===r?(commentParent.find(".tagTrigger").remove(),commentParent.removeAttr("tagenabled"),m=null,$j(".currentTag").removeClass("currentTag"),commentParent.find(".js_taggable").autocomplete("destroy")):(e=(e=i).substring(0,e.length-2),commentParent.find(".tagTrigger").html(e)):46==n||(32==n&&commentParent.attr("tagenabled")?(commentParent.removeAttr("tagenabled"),commentParent.find(".js_taggable").autocomplete("destroy"),commentParent.find(".tagTrigger").remove()):38==t.which||40==t.which||commentParent.attr("tagenabled")&&commentParent.find(".tagTrigger").html(i)):(commentParent.attr("tagenabled","true"),m=$j(this).caret()-1,commentParent.find(".tagTrigger").remove(),commentParent.append('<span class="tagTrigger">'+a+"</span>")),s(commentParent),commentParent.attr("tagenabled")&&c(),syncCharacterCount(commentParent)}),prepareTagging(),renderCommentLinks(),$j(".js_taggableContainer").find(".js_taggable").blur(function(t){t.stopPropagation(),s($j(this))}),$j(".js_taggableContainer").find(".js_taggable").focus(function(t){t.stopPropagation(),$j(".js_taggableContainer").siblings("div.actions").show(),$j(".js_taggableContainer").siblings("div.actions #postComment").attr("disabled",!1)}),$j('div.actions input[type~="submit"], .streamSubmitInput').click(function(t){t.preventDefault()})});